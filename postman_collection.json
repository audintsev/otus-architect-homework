{
	"info": {
		"_postman_id": "ee64de44-c911-470f-b46d-f380b794d9f5",
		"name": "OTUS Architect Homework12",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Create user1",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "513d395a-11de-4c78-8121-71cfa0dbe034",
						"exec": [
							"const locationHeader = pm.response.headers.get('Location')\r",
							"const id = locationHeader.substring(locationHeader.lastIndexOf(\"/\") + 1)\r",
							"pm.environment.set(\"userid1\", id)"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "8f5aeedb-25e8-4898-8a65-06f95ebdfef1",
						"exec": [
							"if (pm.variables.get('forceAdminLogin')) {\r",
							"    const getAdminTokenRequest = {\r",
							"    url: pm.variables.replaceIn(\"{{keycloakUrl}}\") + \"/realms/master/protocol/openid-connect/token\",\r",
							"    method: 'POST',\r",
							"    header: [\r",
							"        'Content-Type:application/x-www-form-urlencoded',\r",
							"        'Accept:application/json'\r",
							"    ],\r",
							"    body: {\r",
							"        mode: 'urlencoded',\r",
							"        urlencoded: [\r",
							"            {key: \"client_id\", value: \"admin-cli\", disabled: false},\r",
							"            {key: \"grant_type\", value: \"password\", disabled: false},\r",
							"            {key: \"username\", value: pm.variables.get(\"keycloakAdminName\"), disabled: false},\r",
							"            {key: \"password\", value: pm.variables.get(\"keycloakAdminPassword\"), disabled: false}\r",
							"        ]\r",
							"    }\r",
							"    };\r",
							"\r",
							"    pm.sendRequest(getAdminTokenRequest, function (err, response) {\r",
							"        pm.environment.set(\"adminAccessToken\", response.json().access_token);\r",
							"    });\r",
							"}\r",
							"\r",
							"pm.environment.set(\"email1\", pm.variables.replaceIn('{{$randomEmail}}'))\r",
							"pm.variables.set(\"firstName\", pm.variables.replaceIn('{{$randomFirstName}}'))\r",
							"pm.variables.set(\"lastName\", pm.variables.replaceIn('{{$randomLastName}}'))"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{adminAccessToken}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"type": "text",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"enabled\": true,\r\n    \"email\": \"{{email1}}\",\r\n    \"firstName\": \"{{firstName}}\",\r\n    \"lastName\": \"{{lastName}}\",\r\n    \"attributes\": {}\r\n}"
				},
				"url": {
					"raw": "{{keycloakUrl}}/admin/realms/{{realm}}/users",
					"host": [
						"{{keycloakUrl}}"
					],
					"path": [
						"admin",
						"realms",
						"{{realm}}",
						"users"
					]
				}
			},
			"response": []
		},
		{
			"name": "Set password for user1",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "392c965b-0d1e-4e90-8ed5-8cf2d0099d06",
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "1f7c717a-eb7a-4345-a1af-a85fedcc65a0",
						"exec": [
							"if (pm.variables.get('forceAdminLogin')) {\r",
							"    const getAdminTokenRequest = {\r",
							"    url: pm.variables.replaceIn(\"{{keycloakUrl}}\") + \"/realms/master/protocol/openid-connect/token\",\r",
							"    method: 'POST',\r",
							"    header: [\r",
							"        'Content-Type:application/x-www-form-urlencoded',\r",
							"        'Accept:application/json'\r",
							"    ],\r",
							"    body: {\r",
							"        mode: 'urlencoded',\r",
							"        urlencoded: [\r",
							"            {key: \"client_id\", value: \"admin-cli\", disabled: false},\r",
							"            {key: \"grant_type\", value: \"password\", disabled: false},\r",
							"            {key: \"username\", value: pm.variables.get(\"keycloakAdminName\"), disabled: false},\r",
							"            {key: \"password\", value: pm.variables.get(\"keycloakAdminPassword\"), disabled: false}\r",
							"        ]\r",
							"    }\r",
							"    };\r",
							"\r",
							"    pm.sendRequest(getAdminTokenRequest, function (err, response) {\r",
							"        pm.variables.set(\"adminAccessToken\", response.json().access_token);\r",
							"    });\r",
							"}\r",
							"\r",
							"pm.environment.set(\"password1\", pm.variables.replaceIn('{{$randomPassword}}'))\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{adminAccessToken}}",
							"type": "string"
						}
					]
				},
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"type": "text",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"type\": \"password\",\r\n    \"value\": \"{{password1}}\",\r\n    \"temporary\": false\r\n}\r\n"
				},
				"url": {
					"raw": "{{keycloakUrl}}/admin/realms/{{realm}}/users/{{userid1}}/reset-password",
					"host": [
						"{{keycloakUrl}}"
					],
					"path": [
						"admin",
						"realms",
						"{{realm}}",
						"users",
						"{{userid1}}",
						"reset-password"
					]
				}
			},
			"response": []
		},
		{
			"name": "Login user1",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "7b9bdc33-2ea5-4bf9-876c-ea8ec77dbe2c",
						"exec": [
							"var responseJSON = JSON.parse(responseBody)\r",
							"pm.environment.set(\"user1AccessToken\", responseJSON[\"access_token\"]);\r",
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "noauth"
				},
				"method": "POST",
				"header": [],
				"body": {
					"mode": "urlencoded",
					"urlencoded": [
						{
							"key": "client_id",
							"value": "{{client}}",
							"type": "text"
						},
						{
							"key": "username",
							"value": "{{email1}}",
							"type": "text"
						},
						{
							"key": "password",
							"value": "{{password1}}",
							"type": "text"
						},
						{
							"key": "grant_type",
							"value": "password",
							"type": "text"
						}
					]
				},
				"url": {
					"raw": "{{keycloakUrl}}/realms/{{realm}}/protocol/openid-connect/token",
					"host": [
						"{{keycloakUrl}}"
					],
					"path": [
						"realms",
						"{{realm}}",
						"protocol",
						"openid-connect",
						"token"
					]
				}
			},
			"response": []
		},
		{
			"name": "List people",
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{user1AccessToken}}",
							"type": "string"
						}
					]
				},
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{baseUrl}}{{pathPrefix}}/app/person",
					"host": [
						"{{baseUrl}}{{pathPrefix}}"
					],
					"path": [
						"app",
						"person"
					]
				}
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"id": "ec0c08be-edeb-41b8-8bac-dbfdb3b65c39",
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"id": "0f6c6ccd-71c4-40c4-b8e1-7acede021763",
				"type": "text/javascript",
				"exec": [
					"tests[\"[INFO] Request: \" + (('data' in request) ? request['data'] : '') ] = true;",
					"tests[\"[INFO] Response: \" + pm.response.code + \" \" + pm.response.status + \", body: \" + responseBody] = true;",
					""
				]
			}
		}
	],
	"variable": [
		{
			"id": "43935141-1fb0-4f9a-80f6-4ea1ebf03481",
			"key": "baseUrl",
			"value": "http://arch.homework"
		},
		{
			"id": "76cedbb3-1b24-466f-860c-34754d1d3a48",
			"key": "pathPrefix",
			"value": "/otusapp/audintsev"
		},
		{
			"id": "2e50103f-83d4-4eab-9526-4fcce1e2e431",
			"key": "keycloakUrl",
			"value": "{{baseUrl}}{{pathPrefix}}/auth"
		},
		{
			"id": "4da196e5-d6c6-4439-bf14-583cdb4d825f",
			"key": "keycloakAdminName",
			"value": "admin"
		},
		{
			"id": "de84c265-fae4-45f3-a105-8ee174fef256",
			"key": "keycloakAdminPassword",
			"value": "admin"
		},
		{
			"id": "bd3175e5-6ea6-4719-bc07-8fa5eb00ff82",
			"key": "forceAdminLogin",
			"value": "true"
		},
		{
			"id": "333cbc0d-e678-4a91-b649-3bad40b228d2",
			"key": "realm",
			"value": "myrealm"
		},
		{
			"id": "edc824b9-7bce-41e9-a2a8-c5beb5cd53bd",
			"key": "client",
			"value": "myclient"
		}
	],
	"protocolProfileBehavior": {}
}